
/**
 * Good Luck
 *
 * 3:51 sleep
 */

definition(
    name: " Static Adhan Player",
    author: "Mohamed Shwail",
    description: "Plays the Adhan on the selected Alexa at the appropriate prayer times.",
    iconUrl: "",
    iconX2Url: "",
    namespace: "com.shwail",
    importUrl: "https://github.com/mshwail/Neverland"
)

preferences {
    page(name: "settingsPage")
    page(name: "adhanSettingsPage")
    page(name: "advancedSettingsPage")
}

def settingsPage() {
    dynamicPage(name: "settingsPage", title: "Settings", install: true, uninstall: true) {
        section {
            input "switches", "capability.switch", title: "switch to trigger Azhan", required: true, multiple: true, submitOnChange: true

            input "pre_switches", "capability.switch", title: "switch to trigger pre Azhan", required: true, multiple: true, submitOnChange: true

            input "shouldSendPushNotification", "bool", title: "Send push notifications?", submitOnChange: true

            if (shouldSendPushNotification) {
                input "notifier", "capability.notification", title: "Notification Device(s)", required: true, multiple: true
            }

            input "preAdhanNotification", "bool", title: "Play notification before Azan ?", submitOnChange: true

            if (preAdhanNotification) {
                input "preadhan", "number", title: "Pre Adhan Notifiction in Minutes", range: "*..*"
            }

            input "muteDevices", "bool", title: "Mute Devices?", submitOnChange: true

            if (muteDevices) {
                input "mute_devices", "capability.audioVolume", title: "Devices to mute during Azan", required: true, multiple: true, submitOnChange: true
            }


            href title: "Advanced Settings", description: "" /* empty string to hide default "Click to show" description */, page: "advancedSettingsPage"
            }
        }
    }


def advancedSettingsPage() {
    dynamicPage(name: "advancedSettingsPage", title: "Advanced Settings") {
        section {
            input "refreshTime", "time", title: "Custom time of day to refresh Adhan times"


            input "debugLoggingEnabled", "bool", title: "Enable Debug Logging"

            mode title: "Set for specific mode(s)"
        }
    }
}

def installed() {
    initialize()
}

def updated() {
    unschedule()
    initialize()
}

def initialize() {
    responseHandler()

    // offset by 30 minutes from midnight to
    // allow backend ample time to resolve to the new date
    // jitter to distribute load
    def scheduleTime = refreshTime ?: toDate("00:${30 + new Random().nextInt(10) /* jitter */}")
    log("Scheduling refreshTimings for ${scheduleTime}")
    schedule(scheduleTime, responseHandler)
}


def responseHandler() {
    def prayers = ['Fajr', 'Dohr', 'Aasr', 'Maghreb', 'Isha']
    times = toDate2()
    times.each {
        def date = toDate(it)

        log("Converted ${it} prayer time to date: ${date}")
        if (new Date().before(date)) {
            log("Scheduling ${prayers[times.indexOf(it)]} prayer adhan...")
            // see http://docs.smartthings.com/en/latest/smartapp-developers-guide/scheduling.html#run-once-in-the-future-runonce
            runOnce(date, playAdhan, [data: [name: prayers[times.indexOf(it)]], overwrite: false])
        } else {
            log("Time for ${prayers[times.indexOf(it)]} prayer passed, not scheduling adhan for today")
        }
       if (preadhan >= 1) {
       int preadhan = (int) preadhan
        use( groovy.time.TimeCategory  ){     Minsago = date - preadhan.minutes }
         if (new Date().before(Minsago)) {
            log("Scheduling notification ${prayers[times.indexOf(it)]} at ${Minsago} prayer adhan...")
            // see http://docs.smartthings.com/en/latest/smartapp-developers-guide/scheduling.html#run-once-in-the-future-runonce
            runOnce(Minsago, playPreAdhan, [data: [name: prayers[times.indexOf(it)]], overwrite: false])
        } else {
            log("Notification Time for ${prayers[times.indexOf(it)]} prayer passed, not scheduling adhan for today")
        }
    }
    if (muteDevices) {
        log("Scheduling mute for  ${prayers[times.indexOf(it)]} at ${date} prayer adhan...")
        runOnce(date, mute)
        use( groovy.time.TimeCategory  ){     unmuteTime = date + 231.seconds }
        log("Scheduling unmute for  ${prayers[times.indexOf(it)]} at ${unmuteTime} prayer adhan...")
        runOnce(unmuteTime, unmute)

    }
} }

def playAdhan(data) {
    def message = "Time for ${data.name} prayer."

    log(message)

    if (shouldSendPushNotification) {
        log("Sending push notification \"${message}\" to ${notifier}")
        notifier.deviceNotification(message)
    }

    switches.each {
        try {
            if (it.hasCommand("on")) {
                it.on()
            }

        } catch (NullPointerException npe) {
            if (it != null) {
                log.error("Error communicating with Alexa");
            }

            throw npe;
        }
    }
}

def toDate(time) {
    def hour = Integer.parseInt(time.substring(0, time.indexOf(':')))
    def min = Integer.parseInt(time.substring(time.indexOf(':') + 1))
    def cal = Calendar.getInstance()
    cal.set(Calendar.HOUR_OF_DAY, hour)
    cal.set(Calendar.MINUTE, min)
    cal.set(Calendar.SECOND, 0)
    cal.getTime()
}

def mute() {
    mute_devices.each{
                if (it.hasCommand("mute")) {
                it.mute()
            }
    }


}

def unmute() {
    mute_devices.each{
                if (it.hasCommand("unmute")) {
                it.unmute()
            }
    }


}

def toDate2() {

def timetable = [1: ['6:43', '12:30', '14:3', '16:19', '18:7'], 2: ['6:43', '12:31', '14:3', '16:20', '18:8'], 3: ['6:43', '12:31', '14:4', '16:22', '18:9'], 4: ['6:43', '12:32', '14:5', '16:23', '18:10'], 5: ['6:43', '12:32', '14:6', '16:24', '18:11'], 6: ['6:43', '12:32', '14:7', '16:25', '18:12'], 7: ['6:42', '12:33', '14:8', '16:26', '18:13'], 8: ['6:42', '12:33', '14:10', '16:28', '18:14'], 9: ['6:42', '12:34', '14:11', '16:29', '18:15'], 10: ['6:41', '12:34', '14:12', '16:31', '18:17'], 11: ['6:41', '12:34', '14:13', '16:32', '18:18'], 12: ['6:41', '12:35', '14:14', '16:34', '18:19'], 13: ['6:40', '12:35', '14:16', '16:35', '18:20'], 14: ['6:39', '12:36', '14:17', '16:37', '18:22'], 15: ['6:39', '12:36', '14:18', '16:38', '18:23'], 16: ['6:38', '12:36', '14:19', '16:40', '18:24'], 17: ['6:37', '12:37', '14:21', '16:41', '18:26'], 18: ['6:37', '12:37', '14:22', '16:43', '18:27'], 19: ['6:36', '12:37', '14:24', '16:45', '18:28'], 20: ['6:35', '12:38', '14:25', '16:47', '18:30'], 21: ['6:34', '12:38', '14:26', '16:48', '18:31'], 22: ['6:33', '12:38', '14:28', '16:50', '18:33'], 23: ['6:32', '12:38', '14:29', '16:52', '18:34'], 24: ['6:31', '12:39', '14:31', '16:54', '18:36'], 25: ['6:30', '12:39', '14:32', '16:56', '18:37'], 26: ['6:29', '12:39', '14:34', '16:57', '18:39'], 27: ['6:28', '12:39', '14:35', '16:59', '18:41'], 28: ['6:27', '12:40', '14:37', '17:1', '18:42'], 29: ['6:26', '12:40', '14:38', '17:3', '18:44'], 30: ['6:24', '12:40', '14:40', '17:5', '18:45'], 31: ['6:23', '12:40', '14:41', '17:7', '18:47'], 32: ['6:22', '12:40', '14:43', '17:9', '18:49'], 33: ['6:20', '12:40', '14:44', '17:11', '18:50'], 34: ['6:19', '12:41', '14:46', '17:13', '18:52'], 35: ['6:18', '12:41', '14:48', '17:15', '18:54'], 36: ['6:16', '12:41', '14:49', '17:17', '18:55'], 37: ['6:15', '12:41', '14:51', '17:19', '18:57'], 38: ['6:13', '12:41', '14:52', '17:21', '18:59'], 39: ['6:12', '12:41', '14:54', '17:23', '19:0'], 40: ['6:10', '12:41', '14:55', '17:25', '19:2'], 41: ['6:8', '12:41', '14:57', '17:26', '19:4'], 42: ['6:7', '12:41', '14:58', '17:28', '19:5'], 43: ['6:5', '12:41', '15:0', '17:30', '19:7'], 44: ['6:3', '12:41', '15:2', '17:32', '19:9'], 45: ['6:2', '12:41', '15:3', '17:34', '19:11'], 46: ['6:0', '12:41', '15:5', '17:36', '19:12'], 47: ['5:58', '12:41', '15:6', '17:38', '19:14'], 48: ['5:56', '12:41', '15:8', '17:40', '19:16'], 49: ['5:55', '12:41', '15:9', '17:42', '19:18'], 50: ['5:53', '12:41', '15:11', '17:44', '19:19'], 51: ['5:51', '12:41', '15:12', '17:46', '19:21'], 52: ['5:49', '12:41', '15:14', '17:48', '19:23'], 53: ['5:47', '12:41', '15:15', '17:50', '19:25'], 54: ['5:45', '12:41', '15:17', '17:52', '19:26'], 55: ['5:43', '12:40', '15:18', '17:54', '19:28'], 56: ['5:41', '12:40', '15:19', '17:56', '19:30'], 57: ['5:39', '12:40', '15:21', '17:58', '19:32'], 58: ['5:37', '12:40', '15:22', '18:0', '19:33'], 59: ['5:35', '12:40', '15:24', '18:2', '19:35'], 60: ['5:35', '12:40', '15:24', '18:2', '19:35'], 61: ['5:33', '12:40', '15:25', '18:4', '19:37'], 62: ['5:31', '12:40', '15:26', '18:6', '19:39'], 63: ['5:28', '12:39', '15:28', '18:8', '19:40'], 64: ['5:26', '12:39', '15:29', '18:9', '19:42'], 65: ['5:24', '12:39', '15:30', '18:11', '19:44'], 66: ['5:22', '12:39', '15:32', '18:13', '19:46'], 67: ['5:20', '12:39', '15:33', '18:15', '19:48'], 68: ['5:17', '12:38', '15:34', '18:17', '19:49'], 69: ['5:15', '12:38', '15:36', '18:19', '19:51'], 70: ['5:13', '12:38', '15:37', '18:21', '19:53'], 71: ['5:11', '12:38', '15:38', '18:23', '19:55'], 72: ['5:8', '12:37', '15:39', '18:24', '19:56'], 73: ['5:6', '12:37', '15:41', '18:26', '19:58'], 74: ['5:4', '12:37', '15:42', '18:28', '20:0'], 75: ['5:1', '12:36', '15:43', '18:30', '20:2'], 76: ['4:59', '12:36', '15:44', '18:32', '20:4'], 77: ['4:56', '12:36', '15:45', '18:34', '20:5'], 78: ['4:54', '12:36', '15:47', '18:36', '20:7'], 79: ['4:52', '12:35', '15:48', '18:37', '20:9'], 80: ['4:49', '12:35', '15:49', '18:39', '20:11'], 81: ['4:47', '12:35', '15:50', '18:41', '20:13'], 82: ['4:44', '12:34', '15:51', '18:43', '20:15'], 83: ['4:42', '12:34', '15:52', '18:45', '20:16'], 84: ['4:39', '12:34', '15:53', '18:46', '20:18'], 85: ['4:37', '12:33', '15:54', '18:48', '20:20'], 86: ['4:34', '12:33', '15:55', '18:50', '20:22'], 87: ['4:32', '12:33', '15:57', '18:52', '20:24'], 88: ['4:29', '12:32', '15:58', '18:54', '20:26'], 89: ['5:27', '13:32', '16:59', '19:55', '21:28'], 90: ['5:24', '13:32', '17:0', '19:57', '21:29'], 91: ['5:22', '13:32', '17:1', '19:59', '21:31'], 92: ['5:19', '13:31', '17:2', '20:1', '21:33'], 93: ['5:17', '13:31', '17:3', '20:3', '21:35'], 94: ['5:14', '13:31', '17:4', '20:4', '21:37'], 95: ['5:11', '13:30', '17:5', '20:6', '21:39'], 96: ['5:9', '13:30', '17:5', '20:8', '21:41'], 97: ['5:6', '13:30', '17:6', '20:10', '21:43'], 98: ['5:4', '13:29', '17:7', '20:12', '21:45'], 99: ['5:1', '13:29', '17:8', '20:13', '21:47'], 100: ['4:59', '13:29', '17:9', '20:15', '21:49'], 101: ['4:56', '13:28', '17:10', '20:17', '21:51'], 102: ['4:53', '13:28', '17:11', '20:19', '21:53'], 103: ['4:51', '13:28', '17:12', '20:21', '21:55'], 104: ['4:48', '13:28', '17:13', '20:22', '21:57'], 105: ['4:46', '13:27', '17:14', '20:24', '21:59'], 106: ['4:43', '13:27', '17:14', '20:26', '22:1'], 107: ['4:40', '13:27', '17:15', '20:28', '22:3'], 108: ['4:38', '13:27', '17:16', '20:30', '22:5'], 109: ['4:35', '13:26', '17:17', '20:31', '22:7'], 110: ['4:33', '13:26', '17:18', '20:33', '22:9'], 111: ['4:30', '13:26', '17:19', '20:35', '22:11'], 112: ['4:28', '13:26', '17:19', '20:37', '22:13'], 113: ['4:25', '13:25', '17:20', '20:39', '22:15'], 114: ['4:23', '13:25', '17:21', '20:40', '22:17'], 115: ['4:20', '13:25', '17:22', '20:42', '22:19'], 116: ['4:17', '13:25', '17:23', '20:44', '22:21'], 117: ['4:15', '13:25', '17:23', '20:46', '22:23'], 118: ['4:12', '13:25', '17:24', '20:48', '22:26'], 119: ['4:10', '13:24', '17:25', '20:49', '22:28'], 120: ['4:8', '13:24', '17:26', '20:51', '22:30'], 121: ['4:5', '13:24', '17:27', '20:53', '22:32'], 122: ['4:3', '13:24', '17:27', '20:55', '22:34'], 123: ['4:0', '13:24', '17:28', '20:57', '22:36'], 124: ['3:58', '13:24', '17:29', '20:58', '22:38'], 125: ['3:55', '13:24', '17:30', '21:0', '22:40'], 126: ['3:53', '13:24', '17:30', '21:2', '22:43'], 127: ['3:51', '13:23', '17:31', '21:4', '22:45'], 128: ['3:48', '13:23', '17:32', '21:6', '22:47'], 129: ['3:46', '13:23', '17:33', '21:7', '22:49'], 130: ['3:44', '13:23', '17:33', '21:9', '22:51'], 131: ['3:41', '13:23', '17:34', '21:11', '22:53'], 132: ['3:39', '13:23', '17:35', '21:13', '22:55'], 133: ['3:37', '13:23', '17:35', '21:14', '22:58'], 134: ['3:35', '13:23', '17:36', '21:16', '23:0'], 135: ['3:33', '13:23', '17:37', '21:18', '23:2'], 136: ['3:30', '13:23', '17:37', '21:19', '23:4'], 137: ['3:28', '13:23', '17:38', '21:21', '23:6'], 138: ['3:26', '13:23', '17:39', '21:23', '23:8'], 139: ['3:24', '13:23', '17:39', '21:24', '23:10'], 140: ['3:22', '13:23', '17:40', '21:26', '23:12'], 141: ['3:20', '13:23', '17:41', '21:27', '23:14'], 142: ['3:18', '13:24', '17:41', '21:29', '23:16'], 143: ['3:16', '13:24', '17:42', '21:31', '23:18'], 144: ['3:15', '13:24', '17:43', '21:32', '23:20'], 145: ['3:13', '13:24', '17:43', '21:34', '23:22'], 146: ['3:11', '13:24', '17:44', '21:35', '23:24'], 147: ['3:9', '13:24', '17:44', '21:37', '23:26'], 148: ['3:8', '13:24', '17:45', '21:38', '23:27'], 149: ['3:6', '13:24', '17:46', '21:39', '23:29'], 150: ['3:4', '13:24', '17:46', '21:41', '23:31'], 151: ['3:3', '13:25', '17:47', '21:42', '23:33'], 152: ['3:1', '13:25', '17:47', '21:43', '23:34'], 153: ['3:0', '13:25', '17:48', '21:45', '23:36'], 154: ['2:59', '13:25', '17:48', '21:46', '23:38'], 155: ['2:57', '13:25', '17:49', '21:47', '23:39'], 156: ['2:56', '13:25', '17:49', '21:48', '23:41'], 157: ['2:55', '13:25', '17:50', '21:49', '23:42'], 158: ['2:54', '13:26', '17:50', '21:50', '23:43'], 159: ['2:53', '13:26', '17:51', '21:51', '23:45'], 160: ['2:52', '13:26', '17:51', '21:52', '23:46'], 161: ['2:51', '13:26', '17:51', '21:53', '23:47'], 162: ['2:50', '13:26', '17:52', '21:54', '23:48'], 163: ['2:49', '13:27', '17:52', '21:55', '23:49'], 164: ['2:49', '13:27', '17:53', '21:56', '23:50'], 165: ['2:48', '13:27', '17:53', '21:56', '23:51'], 166: ['2:47', '13:27', '17:53', '21:57', '23:52'], 167: ['2:47', '13:27', '17:54', '21:58', '23:53'], 168: ['2:47', '13:28', '17:54', '21:58', '23:54'], 169: ['2:46', '13:28', '17:54', '21:59', '23:54'], 170: ['2:46', '13:28', '17:55', '21:59', '23:55'], 171: ['2:46', '13:28', '17:55', '22:0', '23:55'], 172: ['2:46', '13:28', '17:55', '22:0', '23:56'], 173: ['2:46', '13:29', '17:55', '22:0', '23:56'], 174: ['2:46', '13:29', '17:56', '22:1', '23:56'], 175: ['2:47', '13:29', '17:56', '22:1', '23:56'], 176: ['2:47', '13:29', '17:56', '22:1', '23:56'], 177: ['2:47', '13:29', '17:56', '22:1', '23:56'], 178: ['2:48', '13:30', '17:56', '22:1', '23:56'], 179: ['2:48', '13:30', '17:56', '22:1', '23:56'], 180: ['2:49', '13:30', '17:56', '22:1', '23:56'], 181: ['2:50', '13:30', '17:57', '22:1', '23:56'], 182: ['2:51', '13:30', '17:57', '22:0', '23:55'], 183: ['2:52', '13:31', '17:57', '22:0', '23:55'], 184: ['2:53', '13:31', '17:57', '22:0', '23:54'], 185: ['2:54', '13:31', '17:57', '21:59', '23:54'], 186: ['2:55', '13:31', '17:57', '21:59', '23:53'], 187: ['2:56', '13:31', '17:56', '21:58', '23:52'], 188: ['2:57', '13:31', '17:56', '21:58', '23:51'], 189: ['2:58', '13:32', '17:56', '21:57', '23:50'], 190: ['3:0', '13:32', '17:56', '21:56', '23:49'], 191: ['3:1', '13:32', '17:56', '21:56', '23:48'], 192: ['3:3', '13:32', '17:56', '21:55', '23:47'], 193: ['3:4', '13:32', '17:56', '21:54', '23:46'], 194: ['3:6', '13:32', '17:55', '21:53', '23:45'], 195: ['3:7', '13:32', '17:55', '21:52', '23:43'], 196: ['3:9', '13:32', '17:55', '21:51', '23:42'], 197: ['3:11', '13:33', '17:55', '21:50', '23:41'], 198: ['3:13', '13:33', '17:54', '21:49', '23:39'], 199: ['3:14', '13:33', '17:54', '21:48', '23:38'], 200: ['3:16', '13:33', '17:54', '21:47', '23:36'], 201: ['3:18', '13:33', '17:53', '21:45', '23:35'], 202: ['3:20', '13:33', '17:53', '21:44', '23:33'], 203: ['3:22', '13:33', '17:52', '21:43', '23:31'], 204: ['3:24', '13:33', '17:52', '21:42', '23:29'], 205: ['3:26', '13:33', '17:51', '21:40', '23:28'], 206: ['3:28', '13:33', '17:51', '21:39', '23:26'], 207: ['3:30', '13:33', '17:50', '21:37', '23:24'], 208: ['3:32', '13:33', '17:50', '21:36', '23:22'], 209: ['3:34', '13:33', '17:49', '21:34', '23:20'], 210: ['3:36', '13:33', '17:49', '21:33', '23:18'], 211: ['3:38', '13:33', '17:48', '21:31', '23:16'], 212: ['3:40', '13:33', '17:47', '21:29', '23:14'], 213: ['3:42', '13:33', '17:47', '21:28', '23:12'], 214: ['3:44', '13:33', '17:46', '21:26', '23:10'], 215: ['3:46', '13:33', '17:45', '21:24', '23:8'], 216: ['3:49', '13:33', '17:44', '21:22', '23:5'], 217: ['3:51', '13:33', '17:44', '21:21', '23:3'], 218: ['3:53', '13:33', '17:43', '21:19', '23:1'], 219: ['3:55', '13:33', '17:42', '21:17', '22:59'], 220: ['3:57', '13:33', '17:41', '21:15', '22:57'], 221: ['3:59', '13:33', '17:40', '21:13', '22:54'], 222: ['4:1', '13:32', '17:39', '21:11', '22:52'], 223: ['4:4', '13:32', '17:38', '21:9', '22:50'], 224: ['4:6', '13:32', '17:38', '21:7', '22:47'], 225: ['4:8', '13:32', '17:37', '21:5', '22:45'], 226: ['4:10', '13:32', '17:36', '21:3', '22:43'], 227: ['4:12', '13:32', '17:35', '21:1', '22:40'], 228: ['4:14', '13:32', '17:33', '20:59', '22:38'], 229: ['4:16', '13:31', '17:32', '20:57', '22:35'], 230: ['4:19', '13:31', '17:31', '20:55', '22:33'], 231: ['4:21', '13:31', '17:30', '20:53', '22:30'], 232: ['4:23', '13:31', '17:29', '20:51', '22:28'], 233: ['4:25', '13:31', '17:28', '20:48', '22:26'], 234: ['4:27', '13:30', '17:27', '20:46', '22:23'], 235: ['4:29', '13:30', '17:25', '20:44', '22:21'], 236: ['4:31', '13:30', '17:24', '20:42', '22:18'], 237: ['4:33', '13:30', '17:23', '20:40', '22:16'], 238: ['4:35', '13:30', '17:22', '20:37', '22:13'], 239: ['4:37', '13:29', '17:20', '20:35', '22:11'], 240: ['4:39', '13:29', '17:19', '20:33', '22:8'], 241: ['4:41', '13:29', '17:18', '20:31', '22:6'], 242: ['4:43', '13:28', '17:16', '20:28', '22:3'], 243: ['4:45', '13:28', '17:15', '20:26', '22:0'], 244: ['4:47', '13:28', '17:13', '20:24', '21:58'], 245: ['4:49', '13:28', '17:12', '20:21', '21:55'], 246: ['4:51', '13:27', '17:11', '20:19', '21:53'], 247: ['4:53', '13:27', '17:9', '20:17', '21:50'], 248: ['4:55', '13:27', '17:8', '20:14', '21:48'], 249: ['4:57', '13:26', '17:6', '20:12', '21:45'], 250: ['4:59', '13:26', '17:5', '20:9', '21:43'], 251: ['5:1', '13:26', '17:3', '20:7', '21:40'], 252: ['5:3', '13:25', '17:2', '20:5', '21:38'], 253: ['5:5', '13:25', '17:0', '20:2', '21:35'], 254: ['5:7', '13:25', '16:58', '20:0', '21:32'], 255: ['5:9', '13:24', '16:57', '19:57', '21:30'], 256: ['5:10', '13:24', '16:55', '19:55', '21:27'], 257: ['5:12', '13:24', '16:53', '19:52', '21:25'], 258: ['5:14', '13:23', '16:52', '19:50', '21:22'], 259: ['5:16', '13:23', '16:50', '19:48', '21:20'], 260: ['5:18', '13:22', '16:48', '19:45', '21:17'], 261: ['5:20', '13:22', '16:47', '19:43', '21:15'], 262: ['5:21', '13:22', '16:45', '19:40', '21:12'], 263: ['5:23', '13:21', '16:43', '19:38', '21:10'], 264: ['5:25', '13:21', '16:42', '19:35', '21:7'], 265: ['5:27', '13:21', '16:40', '19:33', '21:5'], 266: ['5:28', '13:20', '16:38', '19:30', '21:2'], 267: ['5:30', '13:20', '16:36', '19:28', '21:0'], 268: ['5:32', '13:20', '16:35', '19:25', '20:57'], 269: ['5:34', '13:19', '16:33', '19:23', '20:55'], 270: ['5:35', '13:19', '16:31', '19:20', '20:52'], 271: ['5:37', '13:18', '16:29', '19:18', '20:50'], 272: ['5:39', '13:18', '16:27', '19:16', '20:47'], 273: ['5:41', '13:18', '16:26', '19:13', '20:45'], 274: ['5:42', '13:17', '16:24', '19:11', '20:42'], 275: ['5:44', '13:17', '16:22', '19:8', '20:40'], 276: ['5:46', '13:17', '16:20', '19:6', '20:38'], 277: ['5:47', '13:16', '16:18', '19:3', '20:35'], 278: ['5:49', '13:16', '16:17', '19:1', '20:33'], 279: ['5:51', '13:16', '16:15', '18:58', '20:31'], 280: ['5:52', '13:15', '16:13', '18:56', '20:28'], 281: ['5:54', '13:15', '16:11', '18:54', '20:26'], 282: ['5:56', '13:15', '16:9', '18:51', '20:24'], 283: ['5:57', '13:14', '16:7', '18:49', '20:21'], 284: ['5:59', '13:14', '16:6', '18:46', '20:19'], 285: ['6:1', '13:14', '16:4', '18:44', '20:17'], 286: ['6:2', '13:13', '16:2', '18:42', '20:15'], 287: ['6:4', '13:13', '16:0', '18:39', '20:12'], 288: ['6:6', '13:13', '15:58', '18:37', '20:10'], 289: ['6:7', '13:13', '15:57', '18:35', '20:8'], 290: ['6:9', '13:12', '15:55', '18:32', '20:6'], 291: ['6:11', '13:12', '15:53', '18:30', '20:4'], 292: ['6:12', '13:12', '15:51', '18:28', '20:2'], 293: ['6:14', '13:12', '15:50', '18:26', '20:0'], 294: ['6:16', '13:12', '15:48', '18:23', '19:58'], 295: ['6:17', '13:11', '15:46', '18:21', '19:56'], 296: ['6:19', '13:11', '15:44', '18:19', '19:54'], 297: ['6:21', '13:11', '15:43', '18:17', '19:52'], 298: ['6:22', '13:11', '15:41', '18:15', '19:50'], 299: ['6:24', '13:11', '15:39', '18:13', '19:48'], 300: ['6:26', '13:11', '15:38', '18:10', '19:46'], 301: ['6:27', '13:11', '15:36', '18:8', '19:44'], 302: ['5:29', '12:10', '14:34', '17:6', '18:42'], 303: ['5:31', '12:10', '14:33', '17:4', '18:40'], 304: ['5:32', '12:10', '14:31', '17:2', '18:39'], 305: ['5:34', '12:10', '14:30', '17:0', '18:37'], 306: ['5:35', '12:10', '14:28', '16:58', '18:35'], 307: ['5:37', '12:10', '14:27', '16:56', '18:33'], 308: ['5:39', '12:10', '14:25', '16:54', '18:32'], 309: ['5:40', '12:1', '14:24', '16:52', '18:30'], 310: ['5:42', '12:10', '14:22', '16:51', '18:29'], 311: ['5:44', '12:10', '14:21', '16:49', '18:27'], 312: ['5:45', '12:10', '14:19', '16:47', '18:26'], 313: ['5:47', '12:10', '14:18', '16:45', '18:24'], 314: ['5:48', '12:11', '14:17', '16:43', '18:23'], 315: ['5:50', '12:11', '14:15', '16:42', '18:21'], 316: ['5:52', '12:11', '14:14', '16:40', '18:20'], 317: ['5:53', '12:11', '14:13', '16:38', '18:18'], 318: ['5:55', '12:11', '14:12', '16:37', '18:17'], 319: ['5:56', '12:11', '14:10', '16:35', '18:16'], 320: ['5:58', '12:11', '14:9', '16:34', '18:15'], 321: ['6:0', '12:12', '14:8', '16:32', '18:13'], 322: ['6:1', '12:12', '14:7', '16:31', '18:12'], 323: ['6:3', '12:12', '14:6', '16:29', '18:11'], 324: ['6:4', '12:12', '14:5', '16:28', '18:10'], 325: ['6:6', '12:12', '14:4', '16:27', '18:9'], 326: ['6:7', '12:13', '14:3', '16:25', '18:8'], 327: ['6:9', '12:13', '14:2', '16:24', '18:7'], 328: ['6:10', '12:13', '14:1', '16:23', '18:6'], 329: ['6:12', '12:14', '14:1', '16:22', '18:5'], 330: ['6:13', '12:14', '14:0', '16:21', '18:5'], 331: ['6:14', '12:14', '13:59', '16:20', '18:4'], 332: ['6:16', '12:15', '13:58', '16:19', '18:3'], 333: ['6:17', '12:15', '13:58', '16:18', '18:2'], 334: ['6:19', '12:15', '13:57', '16:17', '18:2'], 335: ['6:20', '12:16', '13:56', '16:16', '18:1'], 336: ['6:21', '12:16', '13:56', '16:15', '18:1'], 337: ['6:22', '12:16', '13:55', '16:15', '18:0'], 338: ['6:24', '12:17', '13:55', '16:14', '18:0'], 339: ['6:25', '12:17', '13:55', '16:13', '17:59'], 340: ['6:26', '12:18', '13:54', '16:13', '17:59'], 341: ['6:27', '12:18', '13:54', '16:12', '17:59'], 342: ['6:28', '12:18', '13:54', '16:12', '17:58'], 343: ['6:29', '12:19', '13:54', '16:11', '17:58'], 344: ['6:30', '12:19', '13:53', '16:11', '17:58'], 345: ['6:31', '12:20', '13:53', '16:11', '17:58'], 346: ['6:32', '12:20', '13:53', '16:10', '17:58'], 347: ['6:33', '12:21', '13:53', '16:10', '17:58'], 348: ['6:34', '12:21', '13:53', '16:10', '17:58'], 349: ['6:35', '12:22', '13:53', '16:10', '17:58'], 350: ['6:36', '12:22', '13:53', '16:10', '17:58'], 351: ['6:37', '12:23', '13:54', '16:10', '17:58'], 352: ['6:38', '12:23', '13:54', '16:10', '17:58'], 353: ['6:38', '12:24', '13:54', '16:10', '17:58'], 354: ['6:39', '12:24', '13:54', '16:11', '17:59'], 355: ['6:40', '12:25', '13:55', '16:11', '17:59'], 356: ['6:40', '12:25', '13:55', '16:11', '18:0'], 357: ['6:41', '12:25', '13:56', '16:12', '18:0'], 358: ['6:41', '12:26', '13:56', '16:12', '18:0'], 359: ['6:42', '12:26', '13:57', '16:13', '18:1'], 360: ['6:42', '12:27', '13:57', '16:13', '18:2'], 361: ['6:42', '12:27', '13:58', '16:14', '18:2'], 362: ['6:43', '12:28', '13:58', '16:15', '18:3'], 363: ['6:43', '12:28', '13:59', '16:16', '18:4'], 364: ['6:43', '12:29', '14:0', '16:16', '18:4'], 365: ['6:43', '12:29', '14:1', '16:17', '18:5'], 366: ['6:43', '12:30', '14:1', '16:18', '18:6'], 367: ['6:43', '12:30', '14:3', '16:19', '18:7']]


def cal = Calendar.getInstance()
/* remove the +1 for leap years */
def dayofyear = cal.get(Calendar.DAY_OF_YEAR) + 1
timetable[dayofyear]
}


def log(message) {
    if (debugLoggingEnabled) {
        log.debug message
    }
}



def playPreAdhan(data) {
    def message = "${preadhan} Minutes to ${data.name} prayer."

    log(message)

    if (shouldSendPushNotification) {
        log("Sending push notification \"${message}\" to ${notifier}")
        notifier.deviceNotification(message)
    }

    pre_switches.each {
        try {
            if (it.hasCommand("on")) {
                it.on()
            }

        } catch (NullPointerException npe) {
            if (it != null) {
                log.error("Error communicating with Alexa");
            }

            throw npe;
        }
    }

}


